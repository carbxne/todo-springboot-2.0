<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Todo List</title>
    <meta charset="UTF-8" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-5">
    <h1 class="text-center mb-4">üìù –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á</h1>

    <!-- –§–æ—Ä–º–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
    <form id="addForm" class="row g-3 mb-4">
        <div class="col-md-4">
            <input type="text" id="title" class="form-control" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫" required />
        </div>
        <div class="col-md-4">
            <input type="text" id="description" class="form-control" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" required />
        </div>
        <div class="col-md-4">
            <button type="submit" class="btn btn-primary w-100">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
        </div>
    </form>

    <table class="table table-bordered table-hover bg-white shadow-sm">
        <thead class="table-dark">
        <tr>
            <th>ID</th>
            <th>–ó–∞–≥–æ–ª–æ–≤–æ–∫</th>
            <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="todo : ${todos}" th:attr="data-id=${todo.id}">
            <td th:text="${todo.id}"></td>
            <td th:text="${todo.title}"></td>
            <td th:text="${todo.description}"></td>
            <td>
                <span th:text="${todo.done ? '‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ' : '‚ùå –ù–µ —Å–¥–µ–ª–∞–Ω–æ'}"></span>
            </td>
            <td>
                <button class="btn btn-sm btn-outline-success toggleDoneBtn me-1">–°—Ç–∞—Ç—É—Å üîÑ</button>
                <button class="btn btn-sm btn-outline-warning editBtn me-1">‚úèÔ∏è</button>
                <button class="btn btn-sm btn-outline-danger deleteBtn">üóëÔ∏è</button>
            </td>
        </tr>
        </tbody>
    </table>
</div>


<script>
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏
    document.getElementById('addForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const title = document.getElementById('title').value.trim();
        const description = document.getElementById('description').value.trim();

        if (!title || !description) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!");

        const response = await fetch('/todos', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title, description, done: false })
        });

        if (response.ok) {
            location.reload(); // –æ–±–Ω–æ–≤–∏–º —Å—Ç—Ä–∞–Ω–∏—Ü—É, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É
        } else {
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏");
        }
    });

    // –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏
    document.querySelectorAll('.deleteBtn').forEach(button => {
        button.onclick = async (e) => {
            const tr = e.target.closest('tr');
            const id = tr.dataset.id;
            const confirmed = confirm(`–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É #${id}?`);
            if (!confirmed) return;

            const response = await fetch(`/todos/${id}`, { method: 'DELETE' });
            if (response.ok) {
                location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏');
            }
        };
    });

    // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ done
    document.querySelectorAll('.toggleDoneBtn').forEach(button => {
        button.onclick = async (e) => {
            const tr = e.target.closest('tr');
            const id = tr.dataset.id;
            const doneCell = tr.children[3];
            const isDone = doneCell.textContent.includes('‚úÖ');

            const response = await fetch(`/todos/${id}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ done: !isDone })
            });

            if (response.ok) {
                location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞');
            }
        };
    });

    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∏ –æ–ø–∏—Å–∞–Ω–∏—è
document.querySelectorAll('.editBtn').forEach(button => {
    button.onclick = async (e) => {
        const tr = e.target.closest('tr');
        const id = tr.dataset.id;
        const title = prompt("–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏:");
        const description = prompt("–ù–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏:");

        if (!title || !description) {
            alert("–ü–æ–ª—è –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º–∏.");
            return;
        }

        const response = await fetch(`/todos/${id}/edit`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title, description })
        });

        if (response.ok) {
            location.reload();
        } else {
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏.");
        }
    };
});

</script>
</body>
</html>
